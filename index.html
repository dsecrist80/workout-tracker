<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Logger</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const EXERCISE_TYPES = {
            compound_lower: { C: 1.3, name: 'Compound Lower' },
            compound_upper: { C: 1.0, name: 'Compound Upper' },
            isolation: { C: 0.4, name: 'Isolation' }
        };

        const MUSCLES = ['Quads', 'Hams', 'Glutes', 'Calves', 'Chest', 'Back', 'Shoulders', 'Bi', 'Tri', 'Forearms', 'Abs', 'LowBack'];

        function WorkoutTracker() {
            const [workouts, setWorkouts] = useState([]);
            const [exercises, setExercises] = useState([]);
            const [programs, setPrograms] = useState([]);
            const [activeProgram, setActiveProgram] = useState(null);
            const [currentDayIndex, setCurrentDayIndex] = useState(0);
            const [session, setSession] = useState([]);
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [view, setView] = useState('session');
            const [selDate, setSelDate] = useState(null);
            
            // Exercise builder
            const [exName, setExName] = useState('');
            const [type, setType] = useState('compound_upper');
            const [axial, setAxial] = useState(false);
            const [prim, setPrim] = useState([]);
            const [sec, setSec] = useState([]);
            const [showAdvanced, setShowAdvanced] = useState(false);

            // Session logging
            const [selEx, setSelEx] = useState('');
            const [sets, setSets] = useState([]);
            const [input, setInput] = useState({ w: '', r: '', rir: '' });
            const [restTimer, setRestTimer] = useState(0);
            const [timerActive, setTimerActive] = useState(false);
            const [repsInputRef, setRepsInputRef] = useState(null);
            const [rirInputRef, setRirInputRef] = useState(null);

            // Program builder
            const [progName, setProgName] = useState('');
            const [progDays, setProgDays] = useState([]);
            const [currentDay, setCurrentDay] = useState({ name: '', exercises: [] });

            useEffect(() => {
                try {
                    const w = localStorage.getItem('w');
                    const e = localStorage.getItem('e');
                    const p = localStorage.getItem('p');
                    const ap = localStorage.getItem('ap');
                    const cdi = localStorage.getItem('cdi');
                    if (w) setWorkouts(JSON.parse(w));
                    if (e) {
                        setExercises(JSON.parse(e));
                    } else {
                        // Populate common exercises on first load
                        const common = [
                            { id: 1, name: 'Barbell Squat', type: 'compound_lower', axial: true, prim: ['Quads', 'Glutes'], sec: ['Hams'] },
                            { id: 2, name: 'Bench Press', type: 'compound_upper', axial: false, prim: ['Chest'], sec: ['Tri', 'Shoulders'] },
                            { id: 3, name: 'Deadlift', type: 'compound_lower', axial: true, prim: ['Hams', 'LowBack', 'Glutes'], sec: [] },
                            { id: 4, name: 'Overhead Press', type: 'compound_upper', axial: true, prim: ['Shoulders'], sec: ['Tri'] },
                            { id: 5, name: 'Barbell Row', type: 'compound_upper', axial: false, prim: ['Back'], sec: ['Bi'] },
                            { id: 6, name: 'Pull-ups', type: 'compound_upper', axial: false, prim: ['Back'], sec: ['Bi'] },
                            { id: 7, name: 'Romanian Deadlift', type: 'compound_lower', axial: true, prim: ['Hams'], sec: ['Glutes', 'LowBack'] },
                            { id: 8, name: 'Leg Press', type: 'compound_lower', axial: false, prim: ['Quads', 'Glutes'], sec: [] },
                            { id: 9, name: 'Dumbbell Bench Press', type: 'compound_upper', axial: false, prim: ['Chest'], sec: ['Tri', 'Shoulders'] },
                            { id: 10, name: 'Lat Pulldown', type: 'compound_upper', axial: false, prim: ['Back'], sec: ['Bi'] },
                            { id: 11, name: 'Leg Curl', type: 'isolation', axial: false, prim: ['Hams'], sec: [] },
                            { id: 12, name: 'Leg Extension', type: 'isolation', axial: false, prim: ['Quads'], sec: [] },
                            { id: 13, name: 'Bicep Curl', type: 'isolation', axial: false, prim: ['Bi'], sec: [] },
                            { id: 14, name: 'Tricep Extension', type: 'isolation', axial: false, prim: ['Tri'], sec: [] },
                            { id: 15, name: 'Lateral Raise', type: 'isolation', axial: false, prim: ['Shoulders'], sec: [] },
                            { id: 16, name: 'Calf Raise', type: 'isolation', axial: false, prim: ['Calves'], sec: [] }
                        ];
                        setExercises(common);
                        saveE(common);
                    }
                    if (p) setPrograms(JSON.parse(p));
                    if (ap) setActiveProgram(JSON.parse(ap));
                    if (cdi) setCurrentDayIndex(parseInt(cdi));
                } catch(err) {}
            }, []);

            useEffect(() => {
                let interval;
                if (timerActive && restTimer > 0) {
                    interval = setInterval(() => {
                        setRestTimer(t => t - 1);
                    }, 1000);
                } else if (restTimer === 0) {
                    setTimerActive(false);
                }
                return () => clearInterval(interval);
            }, [timerActive, restTimer]);

            const saveW = (w) => {
                try { localStorage.setItem('w', JSON.stringify(w)); } catch(e) {}
            };

            const saveE = (e) => {
                try { 
                    localStorage.setItem('e', JSON.stringify(e));
                    // Also save as CSV
                    const csv = exercisesToCSV(e);
                    downloadCSV(csv, 'exercises.csv');
                } catch(err) {}
            };

            const exercisesToCSV = (exs) => {
                const header = 'id,name,type,axial,primary_muscles,secondary_muscles\n';
                const rows = exs.map(ex => {
                    return `${ex.id},"${ex.name}",${ex.type},${ex.axial},` +
                           `"${ex.prim.join(';')}","${ex.sec.join(';')}"`;
                }).join('\n');
                return header + rows;
            };

            const downloadCSV = (csvContent, filename) => {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const loadExercisesFromCSV = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        const exs = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i];
                            const match = line.match(/^(\d+),"([^"]+)",(\w+),(true|false),"([^"]*)","([^"]*)"/);
                            if (match) {
                                exs.push({
                                    id: parseInt(match[1]),
                                    name: match[2],
                                    type: match[3],
                                    axial: match[4] === 'true',
                                    prim: match[5] ? match[5].split(';').filter(m => m) : [],
                                    sec: match[6] ? match[6].split(';').filter(m => m) : []
                                });
                            }
                        }
                        
                        if (exs.length > 0) {
                            setExercises(exs);
                            localStorage.setItem('e', JSON.stringify(exs));
                            alert(`Loaded ${exs.length} exercises from CSV`);
                        }
                    } catch (err) {
                        alert('Error parsing CSV: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };

            const saveP = (p) => {
                try { localStorage.setItem('p', JSON.stringify(p)); } catch(err) {}
            };

            const estI = (r, rir) => {
                const t = r + rir;
                return t <= 1 ? 1 : t <= 5 ? 0.87 : t <= 10 ? 0.75 : t <= 15 ? 0.65 : 0.6;
            };

            const calcS = (set, role, idx) => {
                const I = estI(set.r, set.rir);
                const E = 1 - (set.rir / 5);
                const k = role === 1 ? 0.15 : 0.25;
                return I * Math.pow(set.r, 1.4) * E * role * Math.exp(-k * idx);
            };

            const calcLF = (set, role, idx) => {
                const I = estI(set.r, set.rir);
                const fp = set.rir === 0 ? 1 : (set.rir <= 2 ? 0.5 : 0);
                return Math.pow(I, 2) * set.r * (1 + 0.5 * fp) * role * Math.exp(0.08 * idx);
            };

            const calcSF = (set, t, ax) => {
                const I = estI(set.r, set.rir);
                const f = EXERCISE_TYPES[t];
                const A = ax ? 1.3 : 1.0;
                return Math.pow(I, 1.2) * set.r * f.C * A;
            };

            const calcEx = (ex) => {
                const m = {};
                let sf = 0;
                [...ex.prim, ...ex.sec].forEach(mu => {
                    if (!m[mu]) m[mu] = { s: 0, lf: 0 };
                });
                ex.sets.forEach((set, i) => {
                    ex.prim.forEach(mu => {
                        m[mu].s += calcS(set, 1, i);
                        m[mu].lf += calcLF(set, 1, i);
                    });
                    ex.sec.forEach(mu => {
                        m[mu].s += calcS(set, 0.6, i);
                        m[mu].lf += calcLF(set, 0.6, i);
                    });
                    sf += calcSF(set, ex.type, ex.axial);
                });
                return { m, sf };
            };

            const calcTot = (exs) => {
                const md = {};
                let ts = 0;
                exs.forEach(ex => {
                    const { m, sf } = calcEx(ex);
                    Object.keys(m).forEach(mu => {
                        if (!md[mu]) md[mu] = { s: 0, lf: 0 };
                        md[mu].s += m[mu].s;
                        md[mu].lf += m[mu].lf;
                    });
                    ts += sf;
                });
                return { md, ts };
            };

            const toggle = (mu, isPrim) => {
                if (isPrim) {
                    setPrim(p => p.includes(mu) ? p.filter(m => m !== mu) : [...p, mu]);
                    setSec(s => s.filter(m => m !== mu));
                } else {
                    setSec(s => s.includes(mu) ? s.filter(m => m !== mu) : [...s, mu]);
                    setPrim(p => p.filter(m => m !== mu));
                }
            };

            const saveExercise = () => {
                if (!exName || prim.length === 0) return alert('Enter name and select at least one primary muscle');
                const newId = exercises.length > 0 ? Math.max(...exercises.map(e => e.id)) + 1 : 1;
                const ex = { id: newId, name: exName, type, axial, prim, sec };
                const updated = [...exercises, ex];
                setExercises(updated);
                saveE(updated);
                setExName(''); setPrim([]); setSec([]); setAxial(false); setShowAdvanced(false);
                alert('Exercise saved!');
            };

            const deleteExercise = (id) => {
                const updated = exercises.filter(e => e.id !== id);
                setExercises(updated);
                saveE(updated);
            };

            const addSet = () => {
                if (!input.w || !input.r || input.rir === '') return alert('Fill all fields');
                const newSet = { w: parseFloat(input.w), r: parseInt(input.r), rir: parseInt(input.rir) };
                setSets([...sets, newSet]);
                setInput({ w: input.w, r: '', rir: '' });
                setRestTimer(120);
                setTimerActive(true);
                if (repsInputRef) {
                    setTimeout(() => repsInputRef.focus(), 100);
                }
            };

            const addToSession = () => {
                if (!selEx || sets.length === 0) return alert('Select exercise and add sets');
                const ex = exercises.find(e => e.id === selEx);
                if (!ex) return;
                setSession([...session, { ...ex, sets: [...sets], sessionId: Date.now() }]);
                setSets([]);
                setInput({ w: '', r: '', rir: '' });
                setSelEx('');
                setRestTimer(0);
                setTimerActive(false);
            };

            const finish = () => {
                if (session.length === 0) return alert('Add exercises to session');
                const w = [...session.map(e => ({ ...e, date, id: Date.now() + Math.random() })), ...workouts];
                setWorkouts(w);
                saveW(w);
                setSession([]);
                if (activeProgram) {
                    completeDay();
                }
                alert('Session saved!');
            };

            const getDays = () => {
                const t = new Date();
                const y = t.getFullYear(), mo = t.getMonth();
                const f = new Date(y, mo, 1), l = new Date(y, mo + 1, 0);
                const d = [], s = f.getDay();
                for (let i = 0; i < s; i++) d.push(null);
                for (let i = 1; i <= l.getDate(); i++) d.push(new Date(y, mo, i));
                return d;
            };

            const fmtDate = (d) => d.toISOString().split('T')[0];

            const exByMuscle = () => {
                const grouped = {};
                exercises.forEach(ex => {
                    ex.prim.forEach(m => {
                        if (!grouped[m]) grouped[m] = [];
                        grouped[m].push(ex);
                    });
                });
                return grouped;
            };

            const getPrevPerformance = (exId) => {
                if (!exId) return null;
                const prevWorkouts = workouts.filter(w => w.id === exId).sort((a, b) => new Date(b.date) - new Date(a.date));
                return prevWorkouts.length > 0 ? prevWorkouts[0] : null;
            };

            const handleExerciseSelect = (exId) => {
                setSelEx(exId);
                setSets([]);
                setInput({ w: '', r: '', rir: '' });
                setRestTimer(0);
                setTimerActive(false);
                
                const prev = getPrevPerformance(exId);
                if (prev && prev.sets && prev.sets.length > 0) {
                    setInput({ w: prev.sets[0].w.toString(), r: '', rir: '' });
                }
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const addExToDay = (exId) => {
                const ex = exercises.find(e => e.id == exId);
                if (!ex) return;
                setCurrentDay({...currentDay, exercises: [...currentDay.exercises, { ...ex, sets: 3, reps: 10, rir: 2, exId: ex.id }]});
            };

            const updateExInDay = (idx, field, value) => {
                const updated = [...currentDay.exercises];
                updated[idx][field] = parseInt(value);
                setCurrentDay({...currentDay, exercises: updated});
            };

            const saveDayToProg = () => {
                if (!currentDay.name || currentDay.exercises.length === 0) return alert('Add day name and exercises');
                setProgDays([...progDays, { ...currentDay, id: Date.now() }]);
                setCurrentDay({ name: '', exercises: [] });
            };

            const saveProgram = () => {
                if (!progName || progDays.length === 0) return alert('Add program name and days');
                const prog = { id: Date.now(), name: progName, days: progDays };
                const updated = [...programs, prog];
                setPrograms(updated);
                saveP(updated);
                setProgName('');
                setProgDays([]);
                alert('Program saved!');
            };

            const startProgram = (progId) => {
                const prog = programs.find(p => p.id === progId);
                if (!prog) return;
                setActiveProgram(prog);
                setCurrentDayIndex(0);
                try {
                    localStorage.setItem('ap', JSON.stringify(prog));
                    localStorage.setItem('cdi', '0');
                } catch(e) {}
                alert(`Started program: ${prog.name}`);
            };

            const loadNextDay = () => {
                if (!activeProgram || activeProgram.days.length === 0) return alert('No active program');
                const day = activeProgram.days[currentDayIndex];
                
                // Load exercises with their prescribed sets/reps/rir
                const loadedExercises = day.exercises.map(ex => {
                    const baseEx = exercises.find(e => e.id === ex.exId || e.id === ex.id);
                    return baseEx ? { ...baseEx, prescribedSets: ex.sets, prescribedReps: ex.reps, prescribedRir: ex.rir } : null;
                }).filter(e => e !== null);

                if (loadedExercises.length === 0) return alert('Exercise templates not found');

                // Pre-fill first exercise
                setSelEx(loadedExercises[0].id);
                handleExerciseSelect(loadedExercises[0].id);
                
                setView('session');
                alert(`Loaded: ${day.name} (Day ${currentDayIndex + 1}/${activeProgram.days.length})`);
            };

            const completeDay = () => {
                if (!activeProgram) return;
                const nextIndex = (currentDayIndex + 1) % activeProgram.days.length;
                setCurrentDayIndex(nextIndex);
                try {
                    localStorage.setItem('cdi', nextIndex.toString());
                } catch(e) {}
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="grid grid-cols-2 gap-2 mb-4">
                            <button onClick={() => setView('session')} className={`py-3 rounded-lg font-semibold ${view === 'session' ? 'bg-blue-600 text-white' : 'bg-white text-slate-700'}`}>Session</button>
                            <button onClick={() => setView('exercises')} className={`py-3 rounded-lg font-semibold ${view === 'exercises' ? 'bg-blue-600 text-white' : 'bg-white text-slate-700'}`}>Exercises</button>
                            <button onClick={() => setView('programs')} className={`py-3 rounded-lg font-semibold ${view === 'programs' ? 'bg-blue-600 text-white' : 'bg-white text-slate-700'}`}>Programs</button>
                            <button onClick={() => setView('history')} className={`py-3 rounded-lg font-semibold ${view === 'history' ? 'bg-blue-600 text-white' : 'bg-white text-slate-700'}`}>History</button>
                        </div>

                        {view === 'session' && (
                            <>
                                <div className="bg-white rounded-lg shadow-xl p-6 mb-6">
                                    <h1 className="text-2xl font-bold mb-4">Log Session</h1>
                                    
                                    {activeProgram && (
                                        <div className="mb-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                                            <div className="flex justify-between items-center mb-2">
                                                <div>
                                                    <div className="font-semibold text-purple-900">{activeProgram.name}</div>
                                                    <div className="text-sm text-purple-700">
                                                        Day {currentDayIndex + 1} of {activeProgram.days.length}: {activeProgram.days[currentDayIndex].name}
                                                    </div>
                                                </div>
                                                <button onClick={loadNextDay} className="bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-semibold">
                                                    Load Today's Workout
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="space-y-3">
                                        <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full px-3 py-2 border rounded-md" />
                                        
                                        {exercises.length === 0 ? (
                                            <div className="bg-yellow-50 border border-yellow-200 rounded p-4 text-center">
                                                <p className="text-slate-700 mb-2">No exercises created yet</p>
                                                <button onClick={() => setView('exercises')} className="bg-blue-600 text-white px-4 py-2 rounded-md">Create First Exercise</button>
                                            </div>
                                        ) : (
                                            <>
                                                <div>
                                                    <label className="block text-sm font-medium mb-1">Select Exercise</label>
                                                    <select value={selEx} onChange={(e) => handleExerciseSelect(e.target.value)} className="w-full px-3 py-2 border rounded-md">
                                                        <option value="">Choose an exercise...</option>
                                                        {Object.entries(exByMuscle()).map(([muscle, exs]) => (
                                                            <optgroup key={muscle} label={muscle}>
                                                                {exs.map(ex => (
                                                                    <option key={ex.id} value={ex.id}>{ex.name}</option>
                                                                ))}
                                                            </optgroup>
                                                        ))}
                                                    </select>
                                                </div>

                                                <button onClick={() => setView('exercises')} className="w-full bg-slate-600 text-white py-2 rounded-md">+ New Exercise</button>

                                                {selEx && (
                                                    <>
                                                        {(() => {
                                                            const prev = getPrevPerformance(selEx);
                                                            const selExObj = exercises.find(e => e.id === selEx);
                                                            const hasPrescribed = selExObj && selExObj.prescribedSets;
                                                            
                                                            return (
                                                                <>
                                                                    {hasPrescribed && (
                                                                        <div className="bg-purple-50 border border-purple-200 rounded p-3">
                                                                            <div className="text-sm font-semibold text-purple-900 mb-1">Program Prescription</div>
                                                                            <div className="text-xs text-purple-800">
                                                                                {selExObj.prescribedSets} sets √ó {selExObj.prescribedReps} reps @ {selExObj.prescribedRir} RIR
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                    {prev && prev.sets && prev.sets.length > 0 && (
                                                                        <div className="bg-blue-50 border border-blue-200 rounded p-3">
                                                                            <div className="text-sm font-semibold text-blue-900 mb-1">Last Performance ({new Date(prev.date).toLocaleDateString()})</div>
                                                                            <div className="text-xs text-blue-800">
                                                                                {prev.sets.map((s, i) => (
                                                                                    <span key={i}>{i > 0 && ', '}{s.w}lb √ó {s.r} @ {s.rir}RIR</span>
                                                                                ))}
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </>
                                                            );
                                                        })()}

                                                        {timerActive && restTimer > 0 && (
                                                            <div className="bg-green-50 border border-green-200 rounded p-4 text-center">
                                                                <div className="text-sm font-semibold text-green-900 mb-1">Rest Timer</div>
                                                                <div className="text-3xl font-bold text-green-700">{formatTime(restTimer)}</div>
                                                            </div>
                                                        )}

                                                        {sets.length > 0 && (
                                                            <div className="bg-slate-50 p-3 rounded">
                                                                {sets.map((s, i) => (
                                                                    <div key={i} className="flex justify-between text-sm mb-1">
                                                                        <span>Set {i+1}: {s.w}lb √ó {s.r} @ {s.rir}RIR</span>
                                                                        <button onClick={() => setSets(sets.filter((_, idx) => idx !== i))} className="text-red-500">√ó</button>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}

                                                        <div className="grid grid-cols-3 gap-2">
                                                            <div>
                                                                <label className="block text-xs font-medium mb-1">Weight</label>
                                                                <input type="number" step="0.5" value={input.w} onChange={(e) => setInput({...input, w: e.target.value})} placeholder="lbs" className="w-full px-3 py-2 border rounded-md" />
                                                            </div>
                                                            <div>
                                                                <label className="block text-xs font-medium mb-1">Reps</label>
                                                                <input 
                                                                    ref={(el) => setRepsInputRef(el)}
                                                                    type="number" 
                                                                    value={input.r} 
                                                                    onChange={(e) => setInput({...input, r: e.target.value})} 
                                                                    onKeyPress={(e) => {
                                                                        if (e.key === 'Enter' && rirInputRef) {
                                                                            rirInputRef.focus();
                                                                        }
                                                                    }}
                                                                    placeholder="reps" 
                                                                    className="w-full px-3 py-2 border rounded-md" 
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-xs font-medium mb-1">RIR</label>
                                                                <input 
                                                                    ref={(el) => setRirInputRef(el)}
                                                                    type="number" 
                                                                    value={input.rir} 
                                                                    onChange={(e) => setInput({...input, rir: e.target.value})} 
                                                                    onKeyPress={(e) => {
                                                                        if (e.key === 'Enter' && input.w && input.r && input.rir !== '') {
                                                                            addSet();
                                                                        }
                                                                    }}
                                                                    placeholder="RIR" 
                                                                    className="w-full px-3 py-2 border rounded-md" 
                                                                />
                                                            </div>
                                                        </div>

                                                        <button onClick={addSet} className="w-full bg-blue-600 text-white py-3 rounded-md font-semibold text-lg">+ Add Set</button>
                                                        <button onClick={addToSession} className="w-full bg-green-600 text-white py-2 rounded-md" disabled={sets.length === 0}>‚úì Finish Exercise</button>
                                                    </>
                                                )}
                                            </>
                                        )}
                                    </div>
                                </div>

                                {session.length > 0 && (
                                    <div className="bg-white rounded-lg shadow-xl p-6">
                                        <div className="flex justify-between mb-4">
                                            <h2 className="text-xl font-bold">Current Session ({session.length})</h2>
                                            <button onClick={finish} className="bg-blue-600 text-white px-4 py-2 rounded-md">Finish Session</button>
                                        </div>

                                        {(() => {
                                            const { md, ts } = calcTot(session);
                                            return (
                                                <div className="mb-4 p-3 bg-blue-50 rounded text-sm">
                                                    <div className="font-semibold mb-2">Systemic Fatigue: {ts.toFixed(1)}</div>
                                                    <div className="grid grid-cols-3 gap-2">
                                                        {Object.entries(md).sort((a,b) => b[1].s - a[1].s).map(([mu, d]) => (
                                                            <div key={mu} className="bg-white p-2 rounded text-xs">
                                                                <div className="font-semibold">{mu}</div>
                                                                <div>S: {d.s.toFixed(1)}</div>
                                                                <div>F: {d.lf.toFixed(1)}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })()}

                                        {session.map((ex, i) => {
                                            const { m, sf } = calcEx(ex);
                                            return (
                                                <div key={i} className="border p-3 rounded mb-3 bg-slate-50">
                                                    <div className="flex justify-between mb-2">
                                                        <div>
                                                            <div className="font-semibold">{ex.name}</div>
                                                            <div className="text-xs text-slate-600">{ex.prim.join(', ')}</div>
                                                        </div>
                                                        <button onClick={() => setSession(session.filter((_, idx) => idx !== i))} className="text-red-500">üóëÔ∏è</button>
                                                    </div>
                                                    {ex.sets.map((s, j) => <div key={j} className="text-xs">Set {j+1}: {s.w}lb √ó {s.r} @ {s.rir}RIR</div>)}
                                                    <div className="text-xs mt-2 bg-white p-2 rounded">
                                                        SysFat: {sf.toFixed(1)} | {Object.entries(m).map(([mu, d]) => `${mu}: ${d.s.toFixed(1)}/${d.lf.toFixed(1)}`).join(' | ')}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </>
                        )}

                        {view === 'exercises' && (
                            <div className="bg-white rounded-lg shadow-xl p-6">
                                <h1 className="text-2xl font-bold mb-4">Exercise Library</h1>
                                
                                <div className="space-y-3 mb-6 pb-6 border-b">
                                    <h3 className="font-semibold text-lg">Create New Exercise</h3>
                                    
                                    <input 
                                        type="text" 
                                        value={exName} 
                                        onChange={(e) => setExName(e.target.value)} 
                                        placeholder="Exercise name (e.g., Cable Fly)" 
                                        className="w-full px-3 py-2 border rounded-md" 
                                    />

                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Type</label>
                                            <select value={type} onChange={(e) => setType(e.target.value)} className="w-full px-3 py-2 border rounded-md text-sm">
                                                {Object.entries(EXERCISE_TYPES).map(([k, v]) => <option key={k} value={k}>{v.name}</option>)}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">Axial Load</label>
                                            <label className="flex items-center gap-2 cursor-pointer border rounded-md px-3 py-2 bg-white h-full">
                                                <input type="checkbox" checked={axial} onChange={(e) => setAxial(e.target.checked)} className="w-4 h-4" />
                                                <span className="text-sm">Axially Loaded</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-2">Primary Muscles (required)</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            {MUSCLES.map(m => (
                                                <button 
                                                    key={m} 
                                                    onClick={() => toggle(m, true)} 
                                                    className={`px-3 py-2 text-sm rounded border transition-colors ${
                                                        prim.includes(m) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-700 border-slate-300 hover:bg-slate-50'
                                                    }`}
                                                >
                                                    {m}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <button 
                                        onClick={() => setShowAdvanced(!showAdvanced)} 
                                        className="text-sm text-blue-600 hover:text-blue-800"
                                    >
                                        {showAdvanced ? '‚àí Hide' : '+ Add'} Secondary Muscles (optional)
                                    </button>

                                    {showAdvanced && (
                                        <div className="bg-slate-50 p-4 rounded-lg">
                                            <label className="block text-sm font-medium mb-2">Secondary Muscles</label>
                                            <div className="grid grid-cols-3 gap-2">
                                                {MUSCLES.map(m => (
                                                    <button 
                                                        key={m} 
                                                        onClick={() => toggle(m, false)} 
                                                        className={`px-2 py-1 text-xs rounded border ${
                                                            sec.includes(m) ? 'bg-green-600 text-white border-green-600' : 'bg-white text-slate-700 border-slate-300'
                                                        }`}
                                                    >
                                                        {m}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <button onClick={saveExercise} className="w-full bg-blue-600 text-white py-2 rounded-md font-semibold">Save Exercise</button>
                                </div>

                                <div>
                                    <h2 className="text-xl font-bold mb-3">All Exercises ({exercises.length})</h2>
                                    
                                    <div className="mb-3 flex gap-2 text-sm">
                                        <button 
                                            onClick={() => {
                                                if (exercises.length === 0) {
                                                    alert('No exercises to export');
                                                    return;
                                                }
                                                const csv = exercisesToCSV(exercises);
                                                downloadCSV(csv, 'exercises.csv');
                                            }}
                                            className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                                        >
                                            Export to CSV
                                        </button>
                                        
                                        <label className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 cursor-pointer">
                                            Import from CSV
                                            <input 
                                                type="file" 
                                                accept=".csv" 
                                                onChange={(e) => {
                                                    if (e.target.files[0]) {
                                                        loadExercisesFromCSV(e.target.files[0]);
                                                        e.target.value = '';
                                                    }
                                                }}
                                                className="hidden"
                                            />
                                        </label>
                                        
                                        <button 
                                            onClick={() => {
                                                if (confirm('Load preset exercises? This will add common exercises to your library.')) {
                                                    const common = [
                                                        { id: Date.now() + 1, name: 'Barbell Squat', type: 'compound_lower', axial: true, prim: ['Quads', 'Glutes'], sec: ['Hams'] },
                                                        { id: Date.now() + 2, name: 'Bench Press', type: 'compound_upper', axial: false, prim: ['Chest'], sec: ['Tri', 'Shoulders'] },
                                                        { id: Date.now() + 3, name: 'Deadlift', type: 'compound_lower', axial: true, prim: ['Hams', 'LowBack', 'Glutes'], sec: [] },
                                                        { id: Date.now() + 4, name: 'Overhead Press', type: 'compound_upper', axial: true, prim: ['Shoulders'], sec: ['Tri'] },
                                                        { id: Date.now() + 5, name: 'Barbell Row', type: 'compound_upper', axial: false, prim: ['Back'], sec: ['Bi'] },
                                                        { id: Date.now() + 6, name: 'Pull-ups', type: 'compound_upper', axial: false, prim: ['Back'], sec: ['Bi'] },
                                                        { id: Date.now() + 7, name: 'Romanian Deadlift', type: 'compound_lower', axial: true, prim: ['Hams'], sec: ['Glutes', 'LowBack'] },
                                                        { id: Date.now() + 8, name: 'Leg Press', type: 'compound_lower', axial: false, prim: ['Quads', 'Glutes'], sec: [] },
                                                        { id: Date.now() + 9, name: 'Dumbbell Bench Press', type: 'compound_upper', axial: false, prim: ['Chest'], sec: ['Tri', 'Shoulders'] },
                                                        { id: Date.now() + 10, name: 'Lat Pulldown', type: 'compound_upper', axial: false, prim: ['Back'], sec: ['Bi'] },
                                                        { id: Date.now() + 11, name: 'Leg Curl', type: 'isolation', axial: false, prim: ['Hams'], sec: [] },
                                                        { id: Date.now() + 12, name: 'Leg Extension', type: 'isolation', axial: false, prim: ['Quads'], sec: [] },
                                                        { id: Date.now() + 13, name: 'Bicep Curl', type: 'isolation', axial: false, prim: ['Bi'], sec: [] },
                                                        { id: Date.now() + 14, name: 'Tricep Extension', type: 'isolation', axial: false, prim: ['Tri'], sec: [] },
                                                        { id: Date.now() + 15, name: 'Lateral Raise', type: 'isolation', axial: false, prim: ['Shoulders'], sec: [] },
                                                        { id: Date.now() + 16, name: 'Calf Raise', type: 'isolation', axial: false, prim: ['Calves'], sec: [] }
                                                    ];
                                                    const updated = [...exercises, ...common];
                                                    setExercises(updated);
                                                    saveE(updated);
                                                    alert('Added 16 preset exercises!');
                                                }
                                            }}
                                            className="text-blue-600 hover:text-blue-800 underline"
                                        >
                                            Load Presets
                                        </button>
                                    </div>
                                    
                                    {exercises.length === 0 ? (
                                        <p className="text-slate-500 text-center py-4">No exercises yet</p>
                                    ) : (
                                        <div className="space-y-2">
                                            {exercises.map(ex => (
                                                <div key={ex.id} className="border p-3 rounded flex justify-between items-start hover:bg-slate-50">
                                                    <div>
                                                        <div className="font-semibold">{ex.name}</div>
                                                        <div className="text-xs text-slate-600">
                                                            {ex.prim.join(', ')}
                                                            {ex.sec.length > 0 && ` | 2¬∞: ${ex.sec.join(', ')}`}
                                                        </div>
                                                        <div className="text-xs text-slate-500">
                                                            {EXERCISE_TYPES[ex.type].name}{ex.axial && ' ‚Ä¢ Axial'}
                                                        </div>
                                                    </div>
                                                    <button onClick={() => deleteExercise(ex.id)} className="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'programs' && (
                            <div className="bg-white rounded-lg shadow-xl p-6">
                                <h1 className="text-2xl font-bold mb-4">Program Builder</h1>
                                
                                {activeProgram && (
                                    <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-green-900">Active Program: {activeProgram.name}</div>
                                                <div className="text-sm text-green-700">Currently on Day {currentDayIndex + 1} of {activeProgram.days.length}</div>
                                            </div>
                                            <button 
                                                onClick={() => {
                                                    setActiveProgram(null);
                                                    setCurrentDayIndex(0);
                                                    localStorage.removeItem('ap');
                                                    localStorage.removeItem('cdi');
                                                }} 
                                                className="text-sm text-red-600 hover:text-red-800"
                                            >
                                                Stop Program
                                            </button>
                                        </div>
                                    </div>
                                )}
                                
                                <div className="space-y-4 mb-6 pb-6 border-b">
                                    <h3 className="font-semibold text-lg">Create New Program</h3>
                                    <input type="text" value={progName} onChange={(e) => setProgName(e.target.value)} placeholder="Program name (e.g., Upper/Lower 4-Day)" className="w-full px-3 py-2 border rounded-md" />
                                    
                                    <div className="border rounded-lg p-4 bg-slate-50">
                                        <h3 className="font-semibold mb-3">Build Training Day</h3>
                                        <input type="text" value={currentDay.name} onChange={(e) => setCurrentDay({...currentDay, name: e.target.value})} placeholder="Day name (e.g., Upper A)" className="w-full px-3 py-2 border rounded-md mb-3" />
                                        
                                        {exercises.length === 0 ? (
                                            <div className="text-center py-4 text-slate-500">
                                                <p>No exercises available</p>
                                                <button onClick={() => setView('exercises')} className="mt-2 bg-blue-600 text-white px-4 py-2 rounded-md">Create Exercises</button>
                                            </div>
                                        ) : (
                                            <>
                                                <select onChange={(e) => { if (e.target.value) { addExToDay(e.target.value); e.target.value = ''; } }} className="w-full px-3 py-2 border rounded-md mb-3" value="">
                                                    <option value="">Add exercise...</option>
                                                    {Object.entries(exByMuscle()).map(([muscle, exs]) => (
                                                        <optgroup key={muscle} label={muscle}>
                                                            {exs.map(ex => (
                                                                <option key={ex.id} value={ex.id}>{ex.name}</option>
                                                            ))}
                                                        </optgroup>
                                                    ))}
                                                </select>

                                                {currentDay.exercises.length > 0 && (
                                                    <div className="space-y-2 mb-3">
                                                        {currentDay.exercises.map((ex, i) => (
                                                            <div key={i} className="bg-white p-3 rounded border">
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <span className="font-semibold text-sm">{ex.name}</span>
                                                                    <button onClick={() => setCurrentDay({...currentDay, exercises: currentDay.exercises.filter((_, idx) => idx !== i)})} className="text-red-500">√ó</button>
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-2">
                                                                    <div>
                                                                        <label className="text-xs text-slate-600">Sets</label>
                                                                        <input 
                                                                            type="number" 
                                                                            value={ex.sets} 
                                                                            onChange={(e) => updateExInDay(i, 'sets', e.target.value)}
                                                                            className="w-full px-2 py-1 border rounded text-sm"
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-xs text-slate-600">Reps</label>
                                                                        <input 
                                                                            type="number" 
                                                                            value={ex.reps} 
                                                                            onChange={(e) => updateExInDay(i, 'reps', e.target.value)}
                                                                            className="w-full px-2 py-1 border rounded text-sm"
                                                                        />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-xs text-slate-600">RIR</label>
                                                                        <input 
                                                                            type="number" 
                                                                            value={ex.rir} 
                                                                            onChange={(e) => updateExInDay(i, 'rir', e.target.value)}
                                                                            className="w-full px-2 py-1 border rounded text-sm"
                                                                        />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}

                                                <button onClick={saveDayToProg} className="w-full bg-green-600 text-white py-2 rounded-md">‚úì Add Day to Program</button>
                                            </>
                                        )}
                                    </div>

                                    {progDays.length > 0 && (
                                        <div className="border rounded-lg p-4">
                                            <h3 className="font-semibold mb-3">Program Days ({progDays.length})</h3>
                                            {progDays.map((day, i) => (
                                                <div key={i} className="mb-3 p-3 bg-slate-50 rounded">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="font-semibold">{day.name}</div>
                                                        <button onClick={() => setProgDays(progDays.filter((_, idx) => idx !== i))} className="text-red-500">üóëÔ∏è</button>
                                                    </div>
                                                    {day.exercises.map((ex, j) => (
                                                        <div key={j} className="text-xs text-slate-600">‚Ä¢ {ex.name} - {ex.sets}√ó{ex.reps} @ {ex.rir}RIR</div>
                                                    ))}
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    <button onClick={saveProgram} className="w-full bg-blue-600 text-white py-2 rounded-md" disabled={progDays.length === 0}>Save Program</button>
                                </div>

                                <div>
                                    <h2 className="text-xl font-bold mb-3">Saved Programs ({programs.length})</h2>
                                    {programs.length === 0 ? (
                                        <p className="text-slate-500 text-center py-4">No programs yet</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {programs.map(prog => (
                                                <div key={prog.id} className="border p-4 rounded">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="font-bold text-lg">{prog.name}</div>
                                                        <div className="flex gap-2">
                                                            <button 
                                                                onClick={() => startProgram(prog.id)} 
                                                                className="bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold"
                                                                disabled={activeProgram && activeProgram.id === prog.id}
                                                            >
                                                                {activeProgram && activeProgram.id === prog.id ? 'Active' : 'Start'}
                                                            </button>
                                                            <button onClick={() => { const u = programs.filter(p => p.id !== prog.id); setPrograms(u); saveP(u); }} className="text-red-500">üóëÔ∏è</button>
                                                        </div>
                                                    </div>
                                                    {prog.days.map((day, i) => (
                                                        <div key={i} className="mb-2 pl-3 border-l-2 border-blue-500">
                                                            <div className="font-semibold text-sm">Day {i + 1}: {day.name}</div>
                                                            {day.exercises.map((ex, j) => (
                                                                <div key={j} className="text-xs text-slate-600">‚Ä¢ {ex.name} - {ex.sets}√ó{ex.reps} @ {ex.rir}RIR</div>
                                                            ))}
                                                        </div>
                                                    ))}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="bg-white rounded-lg shadow-xl p-6">
                                <h2 className="text-2xl font-bold mb-4">History</h2>
                                
                                {workouts.length === 0 ? (
                                    <p className="text-center py-8 text-slate-500">No history yet</p>
                                ) : (
                                    <>
                                        <div className="grid grid-cols-7 gap-2 mb-4">
                                            {['Su','Mo','Tu','We','Th','Fr','Sa'].map(d => <div key={d} className="text-center font-semibold text-sm">{d}</div>)}
                                            {getDays().map((day, i) => {
                                                if (!day) return <div key={i} />;
                                                const dk = fmtDate(day);
                                                const dw = workouts.filter(w => w.date === dk);
                                                return (
                                                    <button key={i} onClick={() => dw.length && setSelDate(dk)}
                                                        className={`aspect-square rounded flex flex-col items-center justify-center text-sm ${
                                                            dw.length ? 'bg-green-100 hover:bg-green-200' : 'bg-slate-50'
                                                        } ${dk === new Date().toISOString().split('T')[0] ? 'ring-2 ring-blue-500' : ''}`}>
                                                        <span>{day.getDate()}</span>
                                                        {dw.length > 0 && <span className="text-xs text-green-700">{dw.length}</span>}
                                                    </button>
                                                );
                                            })}
                                        </div>

                                        {selDate && (
                                            <div className="border-t pt-4">
                                                <div className="flex justify-between mb-3">
                                                    <h3 className="font-bold">{new Date(selDate + 'T12:00').toLocaleDateString()}</h3>
                                                    <button onClick={() => setSelDate(null)} className="px-3 py-1 bg-slate-200 rounded text-sm">Close</button>
                                                </div>
                                                {workouts.filter(w => w.date === selDate).map((w, i) => {
                                                    const { m, sf } = calcEx(w);
                                                    return (
                                                        <div key={i} className="border p-3 rounded mb-2 bg-slate-50">
                                                            <div className="font-semibold">{w.name}</div>
                                                            {w.sets.map((s, j) => <div key={j} className="text-xs">Set {j+1}: {s.w}lb √ó {s.r} @ {s.rir}RIR</div>)}
                                                            <div className="text-xs mt-2">SF: {sf.toFixed(1)} | {Object.entries(m).map(([mu, d]) => `${mu}: ${d.s.toFixed(1)}/${d.lf.toFixed(1)}`).join(', ')}</div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<WorkoutTracker />, document.getElementById('root'));
    </script>
</body>
</html>
